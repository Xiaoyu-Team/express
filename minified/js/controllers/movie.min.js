var _=require("underscore"),Movie=require("../models/movie.js"),path=require("path"),fs=require("fs"),db=require("../../config/mongoose")(),UserSchema=require("../schemas/user"),User=db.model("User",UserSchema),CommentSchema=require("../schemas/comment"),Comment=db.model("Comment",CommentSchema),Catetory=require("../models/catetory");exports.new=function(e,o){Catetory.find({}).exec(function(e,t){e&&console.log(e),o.render("admin",{title:"imooc 后台人员",movie:{title:"",doctor:"",country:"",language:"",poster:"",catetory:"",flash:"http://static.youku.com/v1.0.0657/v/swf/loader.swf",year:2014,summary:"不错"},catetory:t})})},exports.update=function(e,o){var t=e.params.id;t&&Movie.findById(t,function(e,t){o.render("admin",{title:"imooc 首页",movies:t})})},exports.save=function(e,o){var t,r=!1,i=e.body;r?Movie.findById(r,function(e,r){e&&console.log(e),t=_.extend(r,i),t.save(function(e,t){e&&console.log(e),o.redirect("/movie/"+t._id)})}):(t=new Movie({doctor:i.doctor,title:i.title,country:i.country,language:i.language,year:i.year,poster:i.poster,catetory:i.catetory,summary:i.summary,flash:i.flash,meta:{createAt:2011,updateAt:2003}}),t.save(function(e,t){e&&console.log(e),Catetory.findById(i.catetory,function(e,o){o.movies.push(t._id),o.save(function(e,o){e&&console.log(e)})}),o.redirect("/movie/"+t._id)}))},exports.list=function(e,o){Movie.fetch(function(e,t){e&&console.log(e),o.render("list",{title:"imooc 首页",movies:t})})},exports.detail=function(e,o){var t=e.params.id;Movie.findById(t,function(e,r){Comment.find({movie:t}).populate("from").exec(function(e,t){o.render("detail",{title:"imooc 详情页"+r.title,movie:r,comments:t})})})},exports.del=function(e,o){var t=e.query.id;t?Movie.remove({_id:t},function(e,t){e?console.log(e):(o.json({success:1}),console.log("success del"))}):o.json({success:1})},exports.Poster=function(e,o,t){console.log("req.files"),console.log(e.files),t()};